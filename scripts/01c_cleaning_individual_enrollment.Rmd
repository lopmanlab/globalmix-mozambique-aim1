---
title: "Mozambique: cleaning individual participant data"
author: mkiti@emory.edu
output: html_document
# date:
---


```{r, echo = FALSE, warning = FALSE, message = FALSE, comment = NA, error= FALSE, cache = F}
rm(list=ls())
library(knitr)
opts_chunk$set(comment = NA, 
               echo = FALSE, 
               warning = FALSE, 
               message = FALSE, 
               error = TRUE, 
               cache = FALSE)
```


```{r imports, echo=FALSE, message = FALSE}
# Load packages
source("scripts/00_load_libraries.R")

# load data
data = rio::import("../raw/all_data_09242021.csv")

# filter
individual_enrolment <- data %>% 
  dplyr::filter(redcap_event_name == "individual_enrollm_arm_1") %>% 
  dplyr::select("rec_id", "redcap_event_name", "date_enrolled", "sex", "sex_other", "birthdate","age", "read_write", "occupation___0", "occupation___1", "occupation___2", "occupation___3", "occupation___4", "occupation___5", "occupation___6", "occupation___7", "occupation___8", "occupation___9", "occupation_other", "enrolled_school", "highest_educ", "school_level", "transport_use", "hh_resp_exposure", "child_breastfeed", "num_simbling", "inscrio_complete", "sensor_id","child", "redcap_repeat_instrument") %>%
    dplyr::filter(redcap_repeat_instrument == "")

```

## Individual enrolment
```{r individual_enrolment, echo=FALSE}
## Individual enrollment records
individual  = individual %>% 
  dplyr::mutate(highest_educlb = case_when(highest_educ == 0 ~ "No schooling", 
                                           highest_educ == 1 ~ "Primary School (1-7)", 
                                           highest_educ == 2 ~ "Basic Secondary school (8-10)",
                                           highest_educ == 3 ~ "Middle Secondary (11-12)", 
                                           highest_educ == 4 ~ "1-3 years of college/university", 
                                           highest_educ == 5 ~ "Bacherols",
                                           highest_educ == 6 ~ "More than Bachelors")) ## check spelling, initially "Bacherols"

ind = ind %>% 
  dplyr::mutate(agelb = case_when(age < 1 ~ "<1", 
                                  age >=1 & age <= 4 ~ "1 - 4y", 
                                  age >=5 & age <=9 ~ "5 - 9y", 
                                  age >=10 & age <=14 ~ "10 - 14y", 
                                  age >=15 & age <=19 ~ "15 - 19y", 
                                  age >=20 & age <=29 ~ "20 - 29y", 
                                  age >=30 & age <=39 ~ "30 - 39y", 
                                  age >=40 & age <=59 ~ "40 - 59y", 
                                  age >=60 ~ "60y+"))

ind = ind %>% 
  dplyr::mutate(sexlb = case_when(sex == 0 ~ "Female", sex == 1 ~ "Male"))

ind$agelb = factor(ind$agelb, 
                   levels = c("<1", "1 - 4y", "5 - 9y", "10 - 14y", "15 - 19y", "20 - 29y", "30 - 39y", "40 - 59y", "60y+"))

```


```{r}
# individual enrollment has sensor_id, household_enrol has aim 2. merge these two, then filter.
sensor1 <- data %>% 
  dplyr::filter(redcap_event_name == "individual_enrollm_arm_1") %>%
  dplyr::select("rec_id", "sensor_id", "age", "sex")


sensor2 <- data %>% 
  dplyr::filter(redcap_event_name == "household_survey_arm_1") %>%
  dplyr::select("redcap_repeat_instrument","redcap_event_name","aim","individual_id","rec_id","study_site","hh","hh_id","hoh_id", 
                "hh_head_gender","hh_occupants") %>%
  dplyr::filter(aim == 1) %>%
  dplyr::filter(redcap_repeat_instrument == "")

sensor <- dplyr::inner_join(sensor1, sensor2, by="rec_id")

# for now, after visually eyeballing, drop sensors with incorrect ID
drop_sensors <- c("1109", "1110","1111","1121","249","1026","1140","478","942",
                  "867","737","738","739","595","596","597","598","1004")
sensor <- sensor[!sensor$rec_id %in% drop_sensors, ]

# Some summary stats
##1. How many people with sensors? By site and age and sex?
n <- dim(sensor[1])

sensor <- sensor %>% 
  dplyr::mutate(agegp = case_when(age < 1 ~ "<1", 
                                  age >=1 & age <= 4 ~ "1-4", 
                                  age >=5 & age <=9 ~ "5-9", 
                                  age >=10 & age <=14 ~ "10-14", 
                                  age >=15 & age <=19 ~ "15-19", 
                                  age >=20 & age <=29 ~ "20-29", 
                                  age >=30 & age <=39 ~ "30-39", 
                                  age >=40 & age <=59 ~ "40-59", 
                                  age >=60 ~ "60+"))
sensor$agegp = factor(sensor$agegp, 
                   levels = c("<1", "1-4", "5-9", "10-14", "15-19", "20-29", "30-39", "40-59", "60+"))


# graph of agegp by site
p <- sensor %>% 
  ggplot(aes(x=agegp, color=study_site, fill=study_site)) +
  geom_histogram(stat = 'count') +
  # theme_ipsum() +
  theme(
    legend.position="none",
    panel.spacing = unit(0.5, "lines"),
    strip.text.x = element_text(size = 8)) +
  facet_wrap(~study_site)
# p

##2. How many households and participants by site?


##3. Average household size by site


```