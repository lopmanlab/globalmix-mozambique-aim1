---
title: "02a_individual_analysis"
author: "M. Kiti"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    # number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, comment = NA)

rm(list=ls())

source("../scripts/00_load_libraries.R")
# source("../scripts/00b_useful_functions.R")
```

## Analysis of participant data

```{r participant, include=FALSE, warning=FALSE}
participant <- readRDS("../Data/individual_info.RDS")

# DataExplorer::create_report(participant)

# cols with 100% missing data, to drop: redcap_repeat_instrument, sex_other.

# cols to be checked: child_breastfeed, occupation_other
```

```{r factorize, echo=FALSE, include=FALSE}
# study site
participant$study_site <- as.factor(participant$study_site)

# participation week
participant$week_enrolled <- weekdays(participant$date_enrolled)
participant$week_enrolled <- factor(participant$week_enrolled,
                                    levels = c("Monday", "Tuesday", "Wednesday", 
                                               "Thursday", "Friday","Saturday","Sunday"),
                                    labels = c("Mon", "Tue", "Wed", "Thur", "Fri",
                                               "Sat","Sun"))
label(participant$week_enrolled) <- "Week enrolled"

# occupation
participant <- participant %>%
  dplyr::mutate(occupation = case_when(occupation___0 == 1 ~ "Unemployed",
                                       occupation___1 == 1 ~ "Student",
                                       occupation___2 == 1 ~ "Office worker",
                                       occupation___3 == 1 ~ "Business person",
                                       occupation___4 == 1 ~ "Casual labor",
                                       occupation___5 == 1 ~ "Farmer",
                                       occupation___6 == 1 ~ "Fishing",
                                       occupation___7 == 1 ~ "Retired",
                                       occupation___8 == 1 ~ "Homemaker/ Housewife",
                                       occupation___9 == 1 ~ "Other"))
participant$occupation <- factor(participant$occupation,
                                 levels = c("Unemployed","Student","Homemaker/ Housewife",
                                            "Casual labor", "Farmer", "Fishing",
                                            "Business person","Office worker",
                                            "Retired", "Other"))
label(participant$occupation) <- "Occupation"

# school level
participant$school_level <- factor(participant$school_level,
                                   levels = c("No schooling", "Primary School (1-7)",
                                              "Basic Secondary school (8-10)",
                                              "Middle Secondary (11-12)", 
                                              "1-3 years of college/university",
                                              "Bachelors","More than Bachelors"))

# highest education level
participant$highest_educ <- factor(participant$highest_educ,
                                   levels = c("No schooling", "Primary School (1-7)",
                                              "Basic Secondary school (8-10)",
                                              "Middle Secondary (11-12)", 
                                              "1-3 years of college/university",
                                              "Bachelors","More than Bachelors"))
```


```{r baseline, echo=FALSE, warning=FALSE}
label(participant$sex) <- "Sex"
label(participant$age) <- "Age"
label(participant$age_cat) <- "Age group"
label(participant$read_write) <- "Can you read and write?"
label(participant$enrolled_school) <- "Currently enrolled in school"
label(participant$highest_educ) <- "Highest education level attained (currently not in school)"
label(participant$school_level) <- "School level (currently in school)"
label(participant$transport_use) <- "Transport use last 3 months"
label(participant$occupation) <- "Occupation"

t1 <- participant %>%
  filter(aim==1) %>%
  select(sex, age_cat, read_write, enrolled_school, school_level, highest_educ, study_site, occupation) %>%
  tbl_summary(by=study_site, 
              percent="column",
              digits = all_categorical() ~ 0,
              missing="no") %>%
  add_overall() %>%
  bold_labels() %>%
  modify_header(label = "") %>%
  # modify_spanning_header(c("stat_1", "stat_2", "stat_3") ~ "**Survey round**") %>%
  modify_caption("**Table 1: Baseline characteristics of Aim 1 participants across sites**")

t2 <- participant %>%
  filter(aim==2) %>%
  select(sex, age_cat, read_write, enrolled_school, school_level, highest_educ, study_site, occupation) %>%
  tbl_summary(by=study_site, 
              percent="column",
              digits = all_categorical() ~ 0,
              missing="no") %>%
  add_overall() %>%
  bold_labels() %>%
  modify_header(label = "") %>%
  # modify_spanning_header(c("stat_1", "stat_2", "stat_3") ~ "**Survey round**") %>%
  modify_caption("**Table 2: Baseline characteristics of Aim 2 participants across sites**")
```

```{r aim1_summary}
t1
# for ages <5 y, we need to include data from the participants in Aim 2.
```

```{r aim2_summary}
t2
```


```{r}
contact_rural_all <- readRDS("../Data/contact_rural_all.RDS")

contact_rural_all$hh_membership <- factor(contact_rural_all$hh_membership,
                                          levels = c("Member", "Non-member")) 
t3 <- contact_rural_all %>%
  # filter(aim==1) %>%
  select(age_group_contact, contact_sex, contact_mask, known_contact, duration_contact, 
         frequency_contact, where_contact, hh_membership) %>%
  tbl_summary(by=hh_membership, 
              percent="row",
              digits = all_categorical() ~ 0,
              missing="no") %>%
  add_overall() %>%
  bold_labels() %>%
  modify_header(label = "") %>%
  # modify_spanning_header(c("stat_1", "stat_2", "stat_3") ~ "**Survey round**") %>%
  modify_caption("**Table 3: Baseline characteristics of contacts**")
t3
```