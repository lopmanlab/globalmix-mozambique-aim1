---
title: "Initial analysis of Mozambique Aim 1 data."
author: "M. Kiti & H. Chen"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    # number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, comment = NA)

rm(list=ls())

source("../scripts/00_load_libraries.R")
# source("../scripts/00b_useful_functions.R")
```

```{r participant, include=FALSE, warning=FALSE}
participant_rural <- readRDS("../data/clean/participant_data_aim1.RDS")

# DataExplorer::create_report(participant_rural)

# cols with 100% missing data, to drop: redcap_repeat_instrument, sex_other.

# cols to be checked: child_breastfeed, occupation_other
```

```{r factorize, echo=FALSE, include=FALSE}

# # participation day, weekday/weekend, weeknumber
# participant_rural$day_of_week <- weekdays(participant_rural$date_enrolled)
# participant_rural$day_of_week <- factor(participant_rural$day_of_week,
#                                     levels = c("Monday", "Tuesday", "Wednesday", 
#                                                "Thursday", "Friday","Saturday","Sunday"),
#                                     labels = c("Mon", "Tue", "Wed", "Thur", "Fri",
#                                                "Sat","Sun"))
# label(participant_rural$day_of_week) <- "Day of week enrolled"
# 
# participant_rural <- participant_rural %>%
#   dplyr::mutate(weekday = case_when(day_of_week == "Mon" ~ "Weekday",
#                                     day_of_week == "Tue" ~ "Weekday",
#                                     day_of_week == "Wed" ~ "Weekday",
#                                     day_of_week == "Thur" ~ "Weekday",
#                                     day_of_week == "Fri" ~ "Weekday",
#                                     day_of_week == "Sat" ~ "Weekend",
#                                     day_of_week == "Sun" ~ "Weekend"))
# participant_rural$weekday <- factor(participant_rural$weekday,
#                               levels = c("Weekday", "Weekend"))
#   
# participant_rural$weeknum <- lubridate::week(ymd(participant_rural$date_enrolled))
# participant_rural$year <- lubridate::year(ymd(participant_rural$date_enrolled)) # check enrollment dates in 2020
# 
# participant_rural$weekyear <- paste(participant_rural$year, participant_rural$weeknum, sep = "-")

```


```{r baseline, echo=FALSE, warning=FALSE}
label(participant_rural$participant_sex) <- "Sex"
# label(participant_rural$participant_age) <- "Age"
label(participant_rural$participant_age) <- "Age group"
# label(participant_rural$participant_age2) <- "Age group"
label(participant_rural$read_write) <- "Can you read and write?"
label(participant_rural$enrolled_school) <- "Currently enrolled in school"
label(participant_rural$highest_educ) <- "Highest education level attained (currently not in school)"
label(participant_rural$school_level) <- "School level (currently in school)"
# label(participant_rural$transport_use) <- "Transport use last 3 months"
label(participant_rural$occupation) <- "Occupation"
# label(participant_rural$weekday) <- "Day of week"
# label(participant_rural$weeknum) <- "Enrollment week number"
# label(participant_rural$year) <- "Enrollment year"

t1 <- participant_rural %>%
  filter(aim==1) %>%
  select(participant_sex, participant_age,  read_write, enrolled_school, 
         school_level, highest_educ, study_site, occupation) %>% # day_of_week, year,
  tbl_summary(by=study_site, 
              percent="column",
              digits = all_categorical() ~ 0,
              missing="no") %>%
  add_overall() %>%
  bold_labels() %>%
  modify_header(label = "") %>%
  # modify_spanning_header(c("stat_1", "stat_2", "stat_3") ~ "**Survey round**") %>%
  modify_caption("**Table 1: Baseline characteristics of Aim 1 participants across sites**")

```
\
\

### Table 1: Baseline characteristics of Aim 1 participants across sites in Mozambique
```{r aim1_summary}
t1
# for ages <5 y, we need to include data from the participants in Aim 2.
```
\
\


```{r}
### Table 2: Contact distribution by covariates in Manhiça

contact_rural <- readRDS("../data/clean/contact_data_aim1.RDS")

# survey date
# participation day, weekday/weekend, weeknumber
contact_rural$day_of_week <- weekdays(contact_rural$survey_date)
contact_rural$day_of_week <- factor(contact_rural$day_of_week,
                                    levels = c("Monday", "Tuesday", "Wednesday", 
                                               "Thursday", "Friday","Saturday","Sunday"),
                                    labels = c("Mon", "Tue", "Wed", "Thur", "Fri",
                                               "Sat","Sun"))
label(contact_rural$day_of_week) <- "Survey date"

contact_rural <- contact_rural %>%
  dplyr::mutate(weekday = case_when(day_of_week == "Mon" ~ "Weekday",
                                    day_of_week == "Tue" ~ "Weekday",
                                    day_of_week == "Wed" ~ "Weekday",
                                    day_of_week == "Thur" ~ "Weekday",
                                    day_of_week == "Fri" ~ "Weekday",
                                    day_of_week == "Sat" ~ "Weekend",
                                    day_of_week == "Sun" ~ "Weekend"))
contact_rural$weekday <- factor(contact_rural$weekday,
                              levels = c("Weekday", "Weekend"))
  
contact_rural$weeknum <- lubridate::week(ymd(contact_rural$survey_date))
contact_rural$year <- lubridate::year(ymd(contact_rural$survey_date)) # check enrollment dates in 2020

contact_rural$weekyear <- paste(contact_rural$year, contact_rural$weeknum, sep = "-")


# relationship
contact_rural$hh_membership <- factor(contact_rural$hh_membership,
                                          levels = c("Member", "Non-member"))

# contact_rural <- contact_rural %>%
#   subset(contact_age != "I don't know")

# contact_rural$contact_age <- as.character(contact_rural$contact_age)
# contact_rural <- contactrecode(contact_rural$contact_age,
#                                   "40-49y"="40-59y", "50-59"="40-59",
#                                   .default = levels(contact_age))
# 
# contact_rural$contact_age = factor(contact_rural$contact_age,
#                    levels = c("<6mo", "6-11mo", "1-4y", "5-9y",
#                               "10-19y", "20-29y", "30-39y",
#                               "40-59y", "60+y"))
# contact_rural$contact_age <- droplevels(contact_rural$contact_age)

label(contact_rural$contact_sex) <- "Sex"
label(contact_rural$contact_age) <- "Age"
label(contact_rural$contact_mask) <- "Was the mask wearing a contact?"
label(contact_rural$known_contact) <- "How long have you known this contact?"
label(contact_rural$duration_contact) <- "How long did the contact last?"
label(contact_rural$frequency_contact) <- "How many times do you have a contact with this person?"
label(contact_rural$where_contact) <- "Where did the contact occur?"
label(contact_rural$hh_membership) <- "Is this a member of your household?"

# summary table for rural contacts
t2 <- contact_rural %>%
  # filter(aim==1) %>%
  select(study_site, contact_age, contact_sex, contact_mask, known_contact, duration_contact,
         frequency_contact, where_contact, hh_membership) %>%
  tbl_summary(by="study_site",
              percent="col",
              digits = all_categorical() ~ 0,
              missing="no") %>%
  add_overall() %>%
  bold_labels() %>%
  modify_header(label = "") %>%
  # modify_spanning_header(c("stat_1", "stat_2", "stat_3") ~ "**Survey round**") %>%
  modify_caption("**Table 2: Contact distribution by covariates in Mozambique**")
t2
```
\
\

```{r}
# distribution of all rural contacts, household and non-household contacts

all_contacts <- contact_rural %>%
  group_by(rec_id) %>%
  dplyr::summarize(all_contacts = n())

hh_contacts <- contact_rural %>%
  filter(hh_membership == "Member") %>%
  group_by(rec_id) %>%
  dplyr::summarize(hh_contacts = n())

nonhh_contacts <- contact_rural %>%
  filter(hh_membership == "Non-member") %>%
  group_by(rec_id) %>%
  dplyr::summarize(nonhh_contacts = n())

```


```{r, include=FALSE}
# merge rural participant and contact data
length(unique(participant_rural$rec_id)) # 2114

participant_rural <- participant_rural %>%
  filter(study_site == "Manhiça")
length(unique(participant_rural$rec_id)) # 730


contact_rural <- dplyr::left_join(participant_rural, contact_rural, by = "rec_id")
length(unique(contact_rural$rec_id)) # 730 records
```

\
\

### Table 3: Contacts in Manhiça only by household membership
# ```{r}
# # this contains contacts when we merge participant and contact data.
# 
# t4 <- contact_rural %>%
#   # filter(aim==1) %>%
#   select(contact_age, contact_sex, day_of_week, weekday, contact_mask, known_contact, duration_contact, frequency_contact, where_contact, hh_membership) %>%
#   tbl_summary(by=hh_membership, 
#               percent="col",
#               digits = all_categorical() ~ 0,
#               missing="no") %>%
#   add_overall() %>%
#   bold_labels() %>%
#   modify_header(label = "") %>%
#   # modify_spanning_header(c("stat_1", "stat_2", "stat_3") ~ "**Survey round**") %>%
#   modify_caption("**Table 4: Baseline characteristics of aim 1 contacts in Manhiça.**")
# t4
# ```


```{r, warning=FALSE, include=FALSE}
# contact boxplots

# overall distribution
contacts_overall_rural <- contact_rural %>%
  group_by(rec_id) %>%
  dplyr::summarize(num_contacts = n())

# 1. age
contacts_age_rural <- contact_rural %>%
  group_by(rec_id, participant_age) %>%   # group by id and count number of contacts
  dplyr::summarize(num_contacts = n())

contacts_age_hh_rural <- contact_rural %>%
  group_by(rec_id, participant_age, hh_membership) %>%   # group by id and count number of contacts
  dplyr::summarize(num_contacts = n())

# 2. sex
# table(contact_rural$participant_sex)
contacts_sex_rural <- contact_rural %>%
  group_by(rec_id, participant_age, participant_sex) %>%   # group by id and count number of contacts
  dplyr::summarize(num_contacts = n())

# 3. enrolled in school
contacts_education_rural <- contact_rural %>%
  group_by(rec_id, enrolled_school) %>%   # group by id and count number of contacts
  drop_na(enrolled_school) %>%
  dplyr::summarize(num_contacts = n())

# # 4. day of week
# contacts_dayweek_rural <- contact_rural %>%
#   group_by(rec_id, participant_age, participant_sex, day_of_week) %>%
#   dplyr::summarize(num_contacts = n()) %>%
#   na.omit()
# 
# # 5. weekday/weekend
# contacts_weekday_rural <- contact_rural %>%
#   group_by(rec_id, weekday) %>%   # group by id and count number of contacts
#   dplyr::summarize(num_contacts = n()) %>%
#   na.omit()
#   
# 
# # 6. year of the week
# contacts_weekyear_rural <- contact_rural %>%
#   group_by(rec_id, weekyear) %>%   # group by id and count number of contacts
#   dplyr::summarize(num_contacts = n())

# 6. household vs nonhousehold member
contacts_hhmember_rural <- contact_rural %>%
  group_by(rec_id, participant_age, participant_sex, hh_membership) %>%   
  drop_na(hh_membership) %>%
  dplyr::summarize(num_contacts = n())
```
\
\

```{r}
library(cowplot)

all_median_rural <- median(contacts_overall_rural$num_contacts)
# agelabs <- c("< 6 months"="0-6mo", "6 - 11 months"="6-11mo", "1 - 4y"="1-4y", 
#              "1 - 5y"="5-9y", "10 - 14y"="10-14y", "15 - 19y"="15-19y", 
#              "20 - 29y"="20-29y", "30 - 39y"="30-39y", "40 - 59y"="40-59y", 
#              "60+y"="60+y")
means <- quantile(contacts_overall_rural$num_contacts, c(.25, .50, .75))

box1 <- ggplot(contacts_age_rural, aes(x = participant_age, y = num_contacts)) # , fill=round
box1 <- box1 +
  geom_boxplot(fill="#bdbdbd", width = .50, position = position_dodge(0.6), outlier.size = 0.5) + #outlier.shape = NA,
  theme_half_open() +
  geom_hline(yintercept = all_median_rural, linetype = "dashed", color = "red") +
  scale_y_continuous(limits = c(0, 40)) +
  labs(fill="", # Round
       x = "Age group",
       y = "Number of contacts" ) +
  theme(legend.title = element_text(size=15),
        legend.text = element_text(size = 12),
        legend.position = c(0.1,0.9)) +
  theme(plot.title = element_text(size = 20), 
        axis.title.x = element_text(size=18, face="bold"),
        axis.title.y = element_text(size=18, face="bold"),
        axis.text.x = element_text(size = 12, angle=0), # changed from txt_size (MK)
        axis.text.y = element_text(size= 16))
# box1


# age and sex
box2 <- ggplot(contacts_sex_rural, aes(x = participant_age, y = num_contacts, fill=participant_sex))
box2 <- box2 +
  geom_boxplot(width = .50, position = position_dodge(0.6), outlier.size = 0.5) + #outlier.shape = NA,
  theme_half_open() +
  scale_fill_manual(values = c("#ef8a62","#67a9cf")) +
  # scale_x_discrete(labels = agelabs) +
  geom_hline(yintercept = all_median_rural, linetype = "dashed", color = "red") +
  scale_y_continuous(limits = c(0, 40)) +
  labs(fill="", # Round
       x = "Age group",
       y = "Number of contacts" ) +
  theme(legend.title = element_text(size=15),
        legend.text = element_text(size = 12),
        legend.position = c(0.05,0.9)) +
  theme(plot.title = element_text(size = 20), 
        axis.title.x = element_text(size=18, face="bold"),
        axis.title.y = element_text(size=18, face="bold"),
        axis.text.x = element_text(size = 12, angle=0), # changed from txt_size (MK)
        axis.text.y = element_text(size= 16))
# box2


# enrolled in school
box3 <- ggplot(contacts_education_rural, aes(x = enrolled_school, y = num_contacts)) # , fill=round
box3 <- box3 +
  geom_boxplot(fill="#bdbdbd", width = .50, position = position_dodge(0.6), outlier.size = 0.5) + #outlier.shape = NA,
  theme_half_open() +
  geom_hline(yintercept = all_median_rural, linetype = "dashed", color = "red") +
  scale_y_continuous(limits = c(0, 40)) +
  # scale_fill_manual(labels = agelabs) + # values = box_colors, 
  labs(fill="", # Round
       y = "Number of contacts",
       x = "Currently enrolled in school" ) +
  theme(legend.title = element_text(size=15),
        legend.text = element_text(size = 12),
        legend.position = c(0.05,1)) +
  theme(plot.title = element_text(size = 20), 
        axis.title.x = element_text(size=24, face="bold"),
        axis.title.y = element_text(size=24, face="bold"),
        axis.text.x = element_text(size = 22, angle=0), # changed from txt_size (MK)
        axis.text.y = element_text(size= 22))
# box3


# # day of the week
# box4 <- ggplot(contacts_dayweek_rural, aes(x = day_of_week, y = num_contacts)) # , fill=round
# box4 <- box4 +
#   geom_boxplot(fill="#bdbdbd", width = .50, position = position_dodge(0.6), outlier.size = 0.5) + #outlier.shape = NA,
#   theme_half_open() +
#   geom_hline(yintercept = all_median_rural, linetype = "dashed", color = "red") +
#   scale_y_continuous(limits = c(0, 40)) +
#   # scale_fill_manual(labels = agelabs) + # values = box_colors, 
#   labs(fill="", # Round
#        y = "Number of contacts",
#        x = "Day of the week" ) +
#   theme(legend.title = element_text(size=15),
#         legend.text = element_text(size = 12),
#         legend.position = c(0.05,1)) +
#   theme(plot.title = element_text(size = 20), 
#         axis.title.x = element_text(size=24, face="bold"),
#         axis.title.y = element_text(size=24, face="bold"),
#         axis.text.x = element_text(size = 22, angle=0), # changed from txt_size (MK)
#         axis.text.y = element_text(size= 22))
# # box4
# 
# 
# # contacts_weekday
# box5 <- ggplot(contacts_weekday_rural, aes(x = weekday, y = num_contacts)) # , fill=round
# box5 <- box5 +
#   geom_boxplot(fill="#bdbdbd", width = .50, position = position_dodge(0.6), outlier.size = 0.5) + #outlier.shape = NA,
#   theme_half_open() +
#   geom_hline(yintercept = all_median_rural, linetype = "dashed", color = "red") +
#   scale_y_continuous(limits = c(0, 40)) +
#   # scale_fill_manual(labels = agelabs) + # values = box_colors, 
#   labs(fill="", # Round
#        x = "Weekday vs weekend",
#        y = "Number of contacts") +
#   theme(legend.title = element_text(size=15),
#         legend.text = element_text(size = 12),
#         legend.position = c(0.05,1)) +
#   theme(plot.title = element_text(size = 20), 
#         axis.title.x = element_text(size=24, face="bold"),
#         axis.title.y = element_text(size=24, face="bold"),
#         axis.text.x = element_text(size = 22, angle=0), # changed from txt_size (MK)
#         axis.text.y = element_text(size= 22))
# # box5
# 
# # 
# # contacts_weekyear
# contacts_weekyear_rural$weekyear <-  factor(contacts_weekyear_rural$weekyear,
#                              levels = c("2021-13", "2021-14", "2021-15", "2021-16",
#                                         "2021-17", "2021-18","2021-19", "2021-20",
#                                         "2021-21", "2021-22", "2021-23", "2021-24",
#                                         "2021-25", "2021-26", "2021-27", "2021-28",
#                                         "2021-29", "2021-30","2021-31", "2021-32",
#                                         "2021-33", "2021-34", "2021-35", "2021-36",
#                                         "2021-37", "2021-38", "2021-39", "2021-40",
#                                         "2021-41", "2021-42","2021-43", "2021-44",
#                                         "2021-45", "2021-46", "2021-47", "2021-48",
#                                         "2021-49", "2021-50", "2022-2",  "2022-4",  
#                                         "2022-6",  "2022-7","2022-8",  "2022-9", 
#                                         "2022-10"))
# box6 <- ggplot(contacts_weekyear_rural, aes(x = weekyear, y = num_contacts)) # , fill=round
# box6 <- box6 +
#   geom_boxplot(fill="#bdbdbd", width = .50, position = position_dodge(0.6), outlier.size = 0.5) + #outlier.shape = NA,
#   theme_half_open() +
#   geom_hline(yintercept = all_median_rural, linetype = "dashed", color = "red") +
#   scale_y_continuous(limits = c(0, 40)) +
#   # scale_fill_manual(labels = agelabs) + # values = box_colors, 
#   labs(fill="", # Round
#        x = "Week",
#        y = "Number of contacts" ) +
#   theme(legend.title = element_text(size=15),
#         legend.text = element_text(size = 12),
#         legend.position = c(0.05,1)) +
#   theme(plot.title = element_text(size = 20), 
#         axis.title.x = element_text(size=18, face="bold"),
#         axis.title.y = element_text(size=18, face="bold"),
#         axis.text.x = element_text(size = 10, angle=90), # changed from txt_size (MK)
#         axis.text.y = element_text(size= 16))
# # box6


# contacts_hhmember
box7 <- ggplot(contacts_hhmember_rural, aes(x = participant_age, y = num_contacts, fill=hh_membership))
box7 <- box7 +
  geom_boxplot(width = .50, position = position_dodge(0.6), outlier.size = 0.5) + #outlier.shape = NA,
  theme_half_open() +
  scale_fill_manual(values = c("#d8b365","#5ab4ac")) +
  # scale_x_discrete(labels = agelabs) +
  geom_hline(yintercept = all_median_rural, linetype = "dashed", color = "red") +
  scale_y_continuous(limits = c(0, 40)) +
  labs(fill="", # Round
       x = "Age group",
       y = "Number of contacts" ) +
  theme(legend.title = element_text(size=15),
        legend.text = element_text(size = 12),
        legend.position = c(0.05,.9)) +
  theme(plot.title = element_text(size = 20), 
        axis.title.x = element_text(size=18, face="bold"),
        axis.title.y = element_text(size=18, face="bold"),
        axis.text.x = element_text(size = 12, angle=0), # changed from txt_size (MK)
        axis.text.y = element_text(size= 16))
# box7
```
\
\

## Figures
```{r, warning=FALSE, include=FALSE}
box1
ggsave("../output/figs/rural_aim1_overall_contacts.pdf", device = "pdf", dpi = 150)

box2
ggsave("../output/figs/rural_aim1_agesex_contacts.pdf", device = "pdf", dpi = 150)

box3
ggsave("../output/figs/rural_aim1_school_contacts.pdf", device = "pdf", dpi = 150)

# box4
# ggsave("../output/figs/rural_aim1_day_contacts.pdf", device = "pdf", dpi = 150)
# 
# box5
# ggsave("../output/figs/rural_aim1_weekday_contacts.pdf", device = "pdf", dpi = 150)
# 
# box6
# ggsave("../output/figs/rural_aim1_weekyear_contacts.pdf", device = "pdf", dpi = 150)

box7
ggsave("../output/figs/rural_aim1_hhmember_contacts.pdf", device = "pdf", dpi = 150)

dev.off()
# box8 <- plot_grid(box1, NULL,
#                   box2, box3,
#                   box4, box5,
#                   box6, box7,
#                   nrow=4, ncol=2,
#                   align="h",rel_heights = c(1,1,1))
# box8
```

# Overall contacts
```{r}
box1
```

# Contacts by age and sex
```{r}
box2
```

# Contacts by education status
```{r}
box3
```

# Contacts by household membership
```{r}
box7
```
\
\

### Figure 1. Distribution of participants by age and sex. 
```{r}
# devtools::install_github('bbc/bbplot')
pacman::p_load('ggalt',
               'forcats', 'R.utils', 'png', 
               'grid', 'ggpubr', 'scales',
               'bbplot','extrafont')

# distribution of age and sex
df_pyramid <- participant_rural %>%
  select(participant_age, participant_sex) %>%
  group_by(participant_age, participant_sex) %>%   # group by id and count number of contacts
  dplyr::summarize(population = n()) %>%
  na.omit()
df_pyramid$population <- df_pyramid$population / sum(df_pyramid$population) * 100
  
rur_pop_pyramid <- ggplot(df_pyramid, aes(x = participant_age, fill = participant_sex,
                                          y = ifelse(test = participant_sex == "Female",
                                                     yes = -population, no = population))) + 
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = abs, limits = max(df_pyramid$population) * c(-1,1)) +
  coord_flip() +
  bbc_style() #+
  # geom_label(aes(x = participant_age, 
  #                y = ifelse(test = participant_sex == "Female",
  #                           yes = -population, no = population),
  #                label = round(population, 0)),
  #            hjust = 0.8, 
  #            vjust = 0.5, 
  #            colour = "black", 
  #            fill = NA, 
  #            label.size = NA, 
  #            family="Gill Sans",
  #            size = 4)

rur_pop_pyramid
# ggsave("../output/figs/rural_aim1_pop_pyramid.pdf", device = "pdf", dpi = 300)
```
\
\

### Figure 2. Distribution of contact characteristics by household membership
```{r}
df_contact_pyramid <- contact_rural %>%
  select(contact_age, hh_membership) %>%
  group_by(contact_age, hh_membership) %>%   # group by id and count number of contacts
  dplyr::summarize(contacts = n()) %>%
  na.omit()
df_contact_pyramid$contacts <- df_contact_pyramid$contacts / sum(df_contact_pyramid$contacts) * 100
  
rur_contact_pyramid <- ggplot(df_contact_pyramid, aes(x = contact_age, fill = hh_membership,
                                          y = ifelse(test = hh_membership == "Member",
                                                     yes = -contacts, no = contacts))) + 
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = abs, limits = max(df_contact_pyramid$contacts) * c(-1,1)) +
  coord_flip() +
  bbc_style() # +
  # geom_label(aes(x = contact_age, 
  #                y = ifelse(test = contact_age == "Member",
  #                           yes = -contacts, no = contacts),
  #                label = round(contacts, 0)),
  #            hjust = 2,
  #            vjust = 0.5, 
  #            colour = "black", 
  #            fill = NA, 
  #            label.size = NA, 
  #            family="Helvetica", 
  #            size = 4)
rur_contact_pyramid
# ggsave("../output/figs/rural_aim1_contact_hh_pyramid.pdf", device = "pdf", dpi = 300)  

```


### Figure 3: Contact matrices in Manhiça
```{r}
# contact matrices

# recategorise participant age
# table(contact_rural$participant_age)

source("../scripts/00b_useful_functions.R")

# contact_rural$participant_age <- contact_rural$participant_age
# contact_rural$participant_age <- recode_factor(contact_rural$participant_age, 
# #                                                 "10-14y"="10-19y", "15-19y"="10-19y")
# contact_rural$participant_age = factor(contact_rural$participant_age, 
#                    levels = c("<6mo", "6-11mo", "1-4y", "5-9y", 
#                               "10-14y","15-19", "20-29y", "30-39y", 
#                               "40-59y", "60+y")) #, "I don't know")) # drop I don't know
# contact_rural$participant_age <- droplevels(contact_rural$participant_age)
# table(contact_rural$participant_age)

# table(contact_rural$contact_age, useNA="always")
# contact_rural$contact_age = factor(contact_rural$contact_age, 
#                    levels = c("<6mo", "6-11mo", "1-4y", "5-9y", 
#                               "10-14y","15-19y", "20-29y", "30-39y", 
#                               "40-59y", "60+y"))
# contact_rural <- filter(contact_rural, !is.na(contact_age)) 
# drop na in contact_age. check where they come from.
# contact_rural$contact_age <- droplevels(contact_rural$contact_age)

standard_str <- data.frame(participant_age = rep(unique(contact_rural$participant_age), each=10),
                            contact_age = rep(unique(contact_rural$participant_age),each = 10))
label(standard_str$contact_age) <- "Age group"
label(standard_str$participant_age) <- "Age group"

# table(standard_str$participant_age)
# table(standard_str$contact_age)
# standard_str$contact_age <- as.character(standard_str$contact_age)
# standard_str$participant_age <- as.character(standard_str$participant_age)
standard_str$participant_age = factor(standard_str$participant_age,
                                                levels = c("<6mo", "6-11mo", "1-4y", "5-9y",
                                                           "10-19y", "20-29y", "30-39y",
                                                           "40-59y", "60+y"))


## Number participants by age group
# table(participant_rural$participant_age)
# participant_rural$participant_age <- as.character(participant_rural$participant_age)
# participant_rural$participant_age[participant_rural$participant_age=="10-14y"] <- "10-19y"
# participant_rural$participant_age[participant_rural$participant_age=="15-19y"] <- "10-19y"
# participant_rural$participant_age = factor(participant_rural$participant_age,
#                                                 levels = c("<6mo", "6-11mo", "1-4y", "5-9y",
#                                                            "10-19y", "20-29y", "30-39y",
#                                                            "40-59y", "60+y"))

aim1_n <- participant_rural %>%
  group_by(participant_age) %>%
  dplyr::summarize(n=n()) 
aim1_n$participant_age = factor(aim1_n$participant_age,
                   levels = c("<6mo", "6-11mo", "1-4y", "5-9y",
                              "10-14y","15-19y", "20-29y", "30-39y",
                              "40-59y", "60+y"))
label(aim1_n$participant_age) <- "Age group"

# contact_rural$contact_age <- as.character(contact_rural$contact_age)
# contact_rural$participant_age <- as.character(contact_rural$participant_age)

# 1. overall matrix
aim1_matrix_all <- make_matrix(contact_rural,
                          title = "Overall contact matrix",
                          legendpos ="none") +
  theme(plot.title = element_text(size = 20), 
        axis.title.x = element_text(size=18, face="bold"),
        axis.title.y = element_text(size=18, face="bold"),
        axis.text.x = element_text(size = 12, angle=0),
        axis.text.y = element_text(size= 16)) +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)),
            color = "black", size = 4)

aa <- contact_rural %>%
    group_by(participant_age, contact_age) %>%
    dplyr::summarize(tot_contacts = n())

# 2. by sex
aim1_matrix_male <- contact_rural %>%
  filter(participant_sex == "Male") %>%
  make_matrix(contact_rural,
                          title = "Male",
                          legendpos ="none") +
  theme(axis.text.x = element_text(angle = 90)) +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)),
            color = "black", size = 2)

aim1_matrix_female <- contact_rural %>%
  filter(participant_sex == "Female") %>%
  make_matrix(contact_rural,
                          title = "Female",
                          legendpos ="none") +  
  theme(axis.text.x = element_text(angle = 90)) +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)),
            color = "black", size = 2)


# # 3. by day of week
# aim1_matrix_weekday <- contact_rural %>%
#   filter(weekday == "Weekday") %>%
#   make_matrix(contact_rural,
#                           title = "Weekday",
#                           legendpos ="none") +
#   theme(axis.text.x = element_text(angle = 90)) +
#   geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)),
#             color = "black", size = 2)
# # aim1_matrix_weekday
# 
# aim1_matrix_weekend<- contact_rural %>%
#   filter(weekday == "Weekend") %>%
#   make_matrix(contact_rural,
#                           title = "Weekend",
#                           legendpos ="none") +
#   theme(axis.text.x = element_text(angle = 90)) +
#   geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)),
#             color = "black", size = 2)
# # aim1_matrix_weekend


# 4. by household vs nonhousehold member
aim1_matrix_member <- contact_rural %>%
  filter(hh_membership == "Member") %>%
  make_matrix(contact_rural,
                          title = "Member",
                          legendpos ="none") +
  theme(axis.text.x = element_text(angle = 90)) +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)),
            color = "black", size = 2)
# aim1_matrix_weekday

aim1_matrix_nonmember <- contact_rural %>%
  filter(hh_membership == "Non-member") %>%
  make_matrix(contact_rural,
                          title = "Non-member",
                          legendpos ="none") +
  theme(axis.text.x = element_text(angle = 90)) +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)),
            color = "black", size = 2)
```


#### A. Overall contact matrix
```{r}
aim1_matrix_all
ggsave("../output/figs/rural_aim1_overall_matrix.pdf", device = "pdf", dpi = 300)

```
\
\

#### B. Contact matrix by sex (male vs female)
```{r}
sex_matrix <- plot_grid(aim1_matrix_male, aim1_matrix_female,
                  nrow=1, ncol=2,
                  align="h",rel_heights = c(1,1))
sex_matrix
```
\
\

#### C. Contact matrix by day of week (weekday vs weekend)
```{r}
weekday_matrix <- plot_grid(aim1_matrix_weekday, aim1_matrix_weekend,
                  nrow=1, ncol=2,
                  align="h",rel_heights = c(1,1))
weekday_matrix
```
\
\

#### D. Contact matrix by household membership (member vs non-member)
```{r}
membership_matrix <- plot_grid(aim1_matrix_member, aim1_matrix_nonmember,
                  nrow=1, ncol=2,
                  align="h",rel_heights = c(1,1))
membership_matrix
```
\
\

```{r, include=FALSE}
temp <- participant_rural %>%
  filter(aim==1) %>%
  filter(study_site=="Manhiça")
table(temp$participant_age, temp$read_write)
```