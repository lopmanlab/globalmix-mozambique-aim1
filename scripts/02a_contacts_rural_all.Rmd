---
title: "Initial analysis of Mozambique Aim 1 data."
author: "M. Kiti & H. Chen"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    # number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, comment = NA)

rm(list=ls())

source("../scripts/00_load_libraries.R")
# source("../scripts/00b_useful_functions.R")
```

```{r participant, include=FALSE, warning=FALSE}
participants <- readRDS("../data/clean/participant_data_aim1.RDS") 
# %>% filter(study_site == "Rural")

# DataExplorer::create_report(participants)

# cols with 100% missing data, to drop: redcap_repeat_instrument, sex_other.

# cols to be checked: child_breastfeed, occupation_other
```

```{r factorize, echo=FALSE, include=FALSE}

# # participation day, weekday/weekend, weeknumber
# participants$day_of_week <- weekdays(participants$date_enrolled)
# participants$day_of_week <- factor(participants$day_of_week,
#                                     levels = c("Monday", "Tuesday", "Wednesday", 
#                                                "Thursday", "Friday","Saturday","Sunday"),
#                                     labels = c("Mon", "Tue", "Wed", "Thur", "Fri",
#                                                "Sat","Sun"))
# label(participants$day_of_week) <- "Day of week enrolled"
# 
# participants<- participants%>%
#   dplyr::mutate(weekday = case_when(day_of_week == "Mon" ~ "Weekday",
#                                     day_of_week == "Tue" ~ "Weekday",
#                                     day_of_week == "Wed" ~ "Weekday",
#                                     day_of_week == "Thur" ~ "Weekday",
#                                     day_of_week == "Fri" ~ "Weekday",
#                                     day_of_week == "Sat" ~ "Weekend",
#                                     day_of_week == "Sun" ~ "Weekend"))
# participants$weekday <- factor(participants$weekday,
#                               levels = c("Weekday", "Weekend"))
#   
# participants$weeknum <- lubridate::week(ymd(participants$date_enrolled))
# participants$year <- lubridate::year(ymd(participants$date_enrolled)) # check enrollment dates in 2020
# 
# participants$weekyear <- paste(participants$year, participants$weeknum, sep = "-")

```


```{r baseline, echo=FALSE, warning=FALSE}
label(participants$participant_sex) <- "Sex"
# label(participants$participant_age) <- "Age"
label(participants$participant_age) <- "Age group"
# label(participants$participant_age2) <- "Age group"
label(participants$read_write) <- "Can you read and write?"
label(participants$enrolled_school) <- "Currently enrolled in school"
label(participants$highest_educ) <- "Highest education level attained (currently not in school)"
label(participants$school_level) <- "School level (currently in school)"
# label(participants$transport_use) <- "Transport use last 3 months"
label(participants$occupation) <- "Occupation"
# label(participants$weekday) <- "Day of week"
# label(participants$weeknum) <- "Enrollment week number"
# label(participants$year) <- "Enrollment year"

t1 <- participants%>%
  filter(aim==1) %>%
  select(study_site, participant_sex, participant_age,  read_write, enrolled_school, 
         school_level, highest_educ, occupation) %>% # day_of_week, year, study_site
  tbl_summary(by=study_site, 
              percent="column",
              digits = all_categorical() ~ 0,
              missing="no") %>%
  # add_overall() %>% 
  bold_labels() %>%
  modify_header(label = "") %>%
  # modify_spanning_header(c("stat_1", "stat_2", "stat_3") ~ "**Survey round**") %>%
  modify_caption("**Table 1: Baseline characteristics of Aim 1 participants in Mozambique**")

```
\
\

### Table 1: Baseline characteristics of Aim 1 participants in Manhica
```{r aim1_summary}
t1
```
\
\

### Table 2: Baseline characteristics of Aim 1 contacts in Mozambique
```{r}
### Table 2: Contact distribution by covariates in Mozambique

contacts <- readRDS("../data/clean/contact_data_aim1.RDS") 
# %>% filter(study_site == "Rural")

# survey date
# participation day, weekday/weekend, weeknumber
contacts$day_of_week <- weekdays(contacts$survey_date)
contacts$day_of_week <- factor(contacts$day_of_week,
                                    levels = c("Monday", "Tuesday", "Wednesday", 
                                               "Thursday", "Friday","Saturday","Sunday"),
                                    labels = c("Mon", "Tue", "Wed", "Thur", "Fri",
                                               "Sat","Sun"))
label(contacts$day_of_week) <- "Survey date"

contacts <- contacts %>%
  dplyr::mutate(weekday = case_when(day_of_week == "Mon" ~ "Weekday",
                                    day_of_week == "Tue" ~ "Weekday",
                                    day_of_week == "Wed" ~ "Weekday",
                                    day_of_week == "Thur" ~ "Weekday",
                                    day_of_week == "Fri" ~ "Weekday",
                                    day_of_week == "Sat" ~ "Weekend",
                                    day_of_week == "Sun" ~ "Weekend"))
contacts$weekday <- factor(contacts$weekday,
                              levels = c("Weekday", "Weekend"))
  
contacts$weeknum <- lubridate::week(ymd(contacts$survey_date))
contacts$year <- lubridate::year(ymd(contacts$survey_date)) # check enrollment dates in 2020

contacts$weekyear <- paste(contacts$year, contacts$weeknum, sep = "-")


# relationship
contacts$hh_membership <- factor(contacts$hh_membership,
                                          levels = c("Member", "Non-member"))

label(contacts$contact_sex) <- "Sex"
label(contacts$contact_age) <- "Age"
label(contacts$contact_mask) <- "Was the mask wearing a contact?"
label(contacts$known_contact) <- "How long have you known this contact?"
label(contacts$duration_contact) <- "How long did the contact last?"
label(contacts$frequency_contact) <- "How many times do you have a contact with this person?"
label(contacts$where_contact) <- "Where did the contact occur?"
label(contacts$hh_membership) <- "Is this a member of your household?"

# summary table for rural contacts
t2 <- contacts %>%
  # filter(aim==1) %>%
  select(study_site, contact_age, contact_sex, contact_mask, known_contact, duration_contact,
         frequency_contact, where_contact, hh_membership) %>% # study_site, 
  tbl_summary(by="study_site",
              percent="col",
              digits = all_categorical() ~ 0,
              missing="no") %>%
  # add_overall() %>%
  bold_labels() %>%
  modify_header(label = "") %>%
  # modify_spanning_header(c("stat_1", "stat_2", "stat_3") ~ "**Survey round**") %>%
  modify_caption("**Table 2: Contact distribution by covariates in Mozambique**")
t2
```
\
\

```{r}
# distribution of all contacts, household and non-household contacts

all_contacts <- contacts %>%
  group_by(rec_id) %>%
  dplyr::summarize(all_contacts = n())

hh_contacts <- contacts %>%
  filter(hh_membership == "Member") %>%
  group_by(rec_id) %>%
  dplyr::summarize(hh_contacts = n())

nonhh_contacts <- contacts %>%
  filter(hh_membership == "Non-member") %>%
  group_by(rec_id) %>%
  dplyr::summarize(nonhh_contacts = n())

```


```{r, echo=FALSE, include=FALSE}
# merge rural participant and contact data
length(unique(participants$rec_id)) # 1452
length(unique(contacts$rec_id)) # 1815, how?? check.

# participants <- participants %>%
#   filter(study_site == "Rural")
# length(unique(participants$rec_id)) # 730


contacts <- participants %>%
  select(rec_id, participant_sex, participant_age, read_write, occupation, enrolled_school,
         highest_education, school_level, transport_use, hh_resp_exposure, number_subling) %>%
  dplyr::left_join(., contacts, by = "rec_id")
length(unique(contacts$rec_id)) # 1452 records
```

\
\

```{r, warning=FALSE, include=FALSE}

# median
q <- c(.25, .5, .75)
rural_median <- contacts %>%
  filter(study_site == "Rural") %>%
  group_by(rec_id, study_site) %>%
  dplyr::summarize(num_contacts = n()) %>%
  group_by(study_site) %>%
  summarize(q25 = quantile(num_contacts, probs = q[1]),
            q50 = quantile(num_contacts, probs = q[2]),
            q75 = quantile(num_contacts, probs = q[3]))
urban_median <- contacts %>%
  filter(study_site == "Urban") %>%
  group_by(rec_id, study_site) %>%
  dplyr::summarize(num_contacts = n()) %>%
  group_by(study_site) %>%
  summarize(q25 = quantile(num_contacts, probs = q[1]),
            q50 = quantile(num_contacts, probs = q[2]),
            q75 = quantile(num_contacts, probs = q[3]))
medians <- rbind(rural_median, urban_median)

# agelabs <- c("< 6 months"="0-6mo", "6 - 11 months"="6-11mo", "1 - 4y"="1-4y", 
#              "1 - 5y"="5-9y", "10 - 14y"="10-14y", "15 - 19y"="15-19y", 
#              "20 - 29y"="20-29y", "30 - 39y"="30-39y", "40 - 59y"="40-59y", 
#              "60+y"="60+y")
#              

# 1. age
contacts_age <- contacts %>%
  group_by(rec_id, study_site, participant_age) %>%   # group by id and count number of contacts
  dplyr::summarize(num_contacts = n())

contacts_age_hh <- contacts %>%
  group_by(rec_id, study_site, participant_age, hh_membership) %>%   # group by id and count number of contacts
  dplyr::summarize(num_contacts = n())

# 2. sex
# table(contacts$participant_sex)
contacts_sex <- contacts %>%
  group_by(rec_id, study_site, participant_age, participant_sex) %>%   # group by id and count number of contacts
  dplyr::summarize(num_contacts = n())

# 3. enrolled in school
contacts_education <- contacts %>%
  group_by(rec_id, study_site, enrolled_school) %>%   # group by id and count number of contacts
  drop_na(enrolled_school) %>%
  dplyr::summarize(num_contacts = n())

# 4. day of week
contacts_dayweek <- contacts %>%
  group_by(rec_id, study_site, participant_age, participant_sex, day_of_week) %>%
  dplyr::summarize(num_contacts = n()) %>%
  na.omit()

# 5. weekday/weekend
contacts_weekday <- contacts %>%
  group_by(rec_id, study_site, weekday) %>%   # group by id and count number of contacts
  dplyr::summarize(num_contacts = n()) %>%
  na.omit()


# 6. year of the week
contacts_weekyear <- contacts %>%
  group_by(rec_id, study_site, weekyear) %>%   # group by id and count number of contacts
  dplyr::summarize(num_contacts = n())

# 6. household vs nonhousehold member
contacts_hhmember <- contacts %>%
  group_by(rec_id, study_site, participant_age, participant_sex, hh_membership) %>%   
  drop_na(hh_membership) %>%
  dplyr::summarize(num_contacts = n())
```
\
\

```{r}
# age
box1 <- contacts_age %>% 
  plotly::plot_ly(x=~participant_age,  y=~num_contacts,  color=~study_site,  
                      type = 'box',  colors = 'Accent') %>%
  plotly::layout(xaxis = list(title= 'Age'),  
                 yaxis = list(title='Number of contacts')) %>%
  plotly::layout(boxmode = "group")

# sex
box2 <- contacts_sex %>% 
  plotly::plot_ly(x=~participant_age,  y=~num_contacts,  color=~participant_sex,  
                      type = 'box',  colors = 'Accent') %>%
  plotly::layout(xaxis = list(title= 'Sex'),  
                 yaxis = list(title='Number of contacts')) %>%
  plotly::layout(boxmode = "group")
# box2

box3 <- contacts_education %>% 
  plotly::plot_ly(x=~enrolled_school,  y=~num_contacts,  color=~study_site,  
                      type = 'box',  colors = 'Accent') %>%
  plotly::layout(xaxis = list(title= 'Enrolled in school'),  
                 yaxis = list(title='Number of contacts')) %>%
  plotly::layout(boxmode = "group")
# box3
#
#
box4 <- contacts_dayweek %>% 
  plotly::plot_ly(x=~day_of_week,  y=~num_contacts,  color=~study_site,  
                      type = 'box',  colors = 'Accent') %>%
  plotly::layout(xaxis = list(title= 'Day of week'),  
                 yaxis = list(title='Number of contacts')) %>%
  plotly::layout(boxmode = "group")
# box4 
# 

box5 <- contacts_weekday %>% 
  plotly::plot_ly(x=~weekday,  y=~num_contacts,  color=~study_site,  
                      type = 'box',  colors = 'Accent') %>%
  plotly::layout(xaxis = list(title= 'Day of week'),  
                 yaxis = list(title='Number of contacts')) %>%
  plotly::layout(boxmode = "group")
box5 


```

```{r}
library(cowplot)

box1 <- ggplot(contacts_age, aes(x = participant_age, y = num_contacts, fill=study_site)) # , fill=round
box1 <- box1 +
  geom_boxplot(fill="#bdbdbd", width = .50, position = position_dodge(0.6), outlier.size = 0.5) + #outlier.shape = NA,
  theme_half_open() +
  # geom_hline(yintercept = all_median, linetype = "dashed", color = "red") +
  scale_y_continuous(limits = c(0, 40)) +
  labs(fill="", # Round
       x = "Age group",
       y = "Number of contacts" ) +
  theme(legend.title = element_text(size=15),
        legend.text = element_text(size = 12),
        legend.position = c(0.1,0.9)) +
  theme(plot.title = element_text(size = 20), 
        axis.title.x = element_text(size=18, face="bold"),
        axis.title.y = element_text(size=18, face="bold"),
        axis.text.x = element_text(size = 12, angle=0), # changed from txt_size (MK)
        axis.text.y = element_text(size= 16))
# box1


# age and sex
box2 <- ggplot(contacts_sex, aes(x = participant_age, y = num_contacts, fill=participant_sex))
box2 <- box2 +
  geom_boxplot(width = .50, position = position_dodge(0.6), outlier.size = 0.5) + #outlier.shape = NA,
  theme_half_open() +
  scale_fill_manual(values = c("#ef8a62","#67a9cf")) +
  # scale_x_discrete(labels = agelabs) +
  # geom_hline(yintercept = all_median, linetype = "dashed", color = "red") +
  scale_y_continuous(limits = c(0, 40)) +
  labs(fill="", # Round
       x = "Age group",
       y = "Number of contacts" ) +
  theme(legend.title = element_text(size=15),
        legend.text = element_text(size = 12),
        legend.position = c(0.05,0.9)) +
  theme(plot.title = element_text(size = 20), 
        axis.title.x = element_text(size=18, face="bold"),
        axis.title.y = element_text(size=18, face="bold"),
        axis.text.x = element_text(size = 12, angle=0), # changed from txt_size (MK)
        axis.text.y = element_text(size= 16))
# box2


# enrolled in school
box3 <- ggplot(contacts_education, aes(x = enrolled_school, y = num_contacts)) # , fill=round
box3 <- box3 +
  geom_boxplot(fill="#bdbdbd", width = .50, position = position_dodge(0.6), outlier.size = 0.5) + #outlier.shape = NA,
  theme_half_open() +
  # geom_hline(yintercept = all_median, linetype = "dashed", color = "red") +
  scale_y_continuous(limits = c(0, 40)) +
  # scale_fill_manual(labels = agelabs) + # values = box_colors, 
  labs(fill="", # Round
       y = "Number of contacts",
       x = "Currently enrolled in school" ) +
  theme(legend.title = element_text(size=15),
        legend.text = element_text(size = 12),
        legend.position = c(0.05,1)) +
  theme(plot.title = element_text(size = 20), 
        axis.title.x = element_text(size=24, face="bold"),
        axis.title.y = element_text(size=24, face="bold"),
        axis.text.x = element_text(size = 22, angle=0), # changed from txt_size (MK)
        axis.text.y = element_text(size= 22))
# box3


# day of the week
box4 <- ggplot(contacts_dayweek, aes(x = day_of_week, y = num_contacts)) # , fill=round
box4 <- box4 +
  geom_boxplot(fill="#bdbdbd", width = .50, position = position_dodge(0.6), outlier.size = 0.5) + #outlier.shape = NA,
  theme_half_open() +
  # geom_hline(yintercept = all_median, linetype = "dashed", color = "red") +
  scale_y_continuous(limits = c(0, 40)) +
  # scale_fill_manual(labels = agelabs) + # values = box_colors,
  labs(fill="", # Round
       y = "Number of contacts",
       x = "Day of the week" ) +
  theme(legend.title = element_text(size=15),
        legend.text = element_text(size = 12),
        legend.position = c(0.05,1)) +
  theme(plot.title = element_text(size = 20),
        axis.title.x = element_text(size=24, face="bold"),
        axis.title.y = element_text(size=24, face="bold"),
        axis.text.x = element_text(size = 22, angle=0), # changed from txt_size (MK)
        axis.text.y = element_text(size= 22))
# box4


# contacts_weekday
box5 <- ggplot(contacts_weekday, aes(x = weekday, y = num_contacts)) # , fill=round
box5 <- box5 +
  geom_boxplot(fill="#bdbdbd", width = .50, position = position_dodge(0.6), outlier.size = 0.5) + #outlier.shape = NA,
  theme_half_open() +
  # geom_hline(yintercept = all_median, linetype = "dashed", color = "red") +
  scale_y_continuous(limits = c(0, 40)) +
  # scale_fill_manual(labels = agelabs) + # values = box_colors,
  labs(fill="", # Round
       x = "Weekday vs weekend",
       y = "Number of contacts") +
  theme(legend.title = element_text(size=15),
        legend.text = element_text(size = 12),
        legend.position = c(0.05,1)) +
  theme(plot.title = element_text(size = 20),
        axis.title.x = element_text(size=24, face="bold"),
        axis.title.y = element_text(size=24, face="bold"),
        axis.text.x = element_text(size = 22, angle=0), # changed from txt_size (MK)
        axis.text.y = element_text(size= 22))
# box5

#
# contacts_weekyear
contacts_weekyear$weekyear <-  factor(contacts_weekyear$weekyear,
                             levels = c("2021-13", "2021-14", "2021-15", "2021-16",
                                        "2021-17", "2021-18","2021-19", "2021-20",
                                        "2021-21", "2021-22", "2021-23", "2021-24",
                                        "2021-25", "2021-26", "2021-27", "2021-28",
                                        "2021-29", "2021-30","2021-31", "2021-32",
                                        "2021-33", "2021-34", "2021-35", "2021-36",
                                        "2021-37", "2021-38", "2021-39", "2021-40",
                                        "2021-41", "2021-42","2021-43", "2021-44",
                                        "2021-45", "2021-46", "2021-47", "2021-48",
                                        "2021-49", "2021-50", "2022-2",  "2022-4",
                                        "2022-6",  "2022-7","2022-8",  "2022-9",
                                        "2022-10"))
box6 <- ggplot(contacts_weekyear, aes(x = weekyear, y = num_contacts)) # , fill=round
box6 <- box6 +
  geom_boxplot(fill="#bdbdbd", width = .50, position = position_dodge(0.6), outlier.size = 0.5) + #outlier.shape = NA,
  theme_half_open() +
  # geom_hline(yintercept = all_median, linetype = "dashed", color = "red") +
  scale_y_continuous(limits = c(0, 40)) +
  # scale_fill_manual(labels = agelabs) + # values = box_colors,
  labs(fill="", # Round
       x = "Week",
       y = "Number of contacts" ) +
  theme(legend.title = element_text(size=15),
        legend.text = element_text(size = 12),
        legend.position = c(0.05,1)) +
  theme(plot.title = element_text(size = 20),
        axis.title.x = element_text(size=18, face="bold"),
        axis.title.y = element_text(size=18, face="bold"),
        axis.text.x = element_text(size = 10, angle=90), # changed from txt_size (MK)
        axis.text.y = element_text(size= 16))
# box6


# contacts_hhmember
box7 <- ggplot(contacts_hhmember, aes(x = participant_age, y = num_contacts, fill=hh_membership))
box7 <- box7 +
  geom_boxplot(width = .50, position = position_dodge(0.6), outlier.size = 0.5) + #outlier.shape = NA,
  theme_half_open() +
  scale_fill_manual(values = c("#d8b365","#5ab4ac")) +
  # scale_x_discrete(labels = agelabs) +
  # geom_hline(yintercept = all_median, linetype = "dashed", color = "red") +
  scale_y_continuous(limits = c(0, 40)) +
  labs(fill="", # Round
       x = "Age group",
       y = "Number of contacts" ) +
  theme(legend.title = element_text(size=15),
        legend.text = element_text(size = 12),
        legend.position = c(0.05,.9)) +
  theme(plot.title = element_text(size = 20), 
        axis.title.x = element_text(size=18, face="bold"),
        axis.title.y = element_text(size=18, face="bold"),
        axis.text.x = element_text(size = 12, angle=0), # changed from txt_size (MK)
        axis.text.y = element_text(size= 16))
# box7
```
\
\

## Figures
```{r, warning=FALSE, include=FALSE}
box1
ggsave("../output/figs/rural_aim1_overall_contacts.pdf", device = "pdf", dpi = 150)

box2
ggsave("../output/figs/rural_aim1_agesex_contacts.pdf", device = "pdf", dpi = 150)

box3
ggsave("../output/figs/rural_aim1_school_contacts.pdf", device = "pdf", dpi = 150)

# box4
# ggsave("../output/figs/rural_aim1_day_contacts.pdf", device = "pdf", dpi = 150)
# 
# box5
# ggsave("../output/figs/rural_aim1_weekday_contacts.pdf", device = "pdf", dpi = 150)
# 
# box6
# ggsave("../output/figs/rural_aim1_weekyear_contacts.pdf", device = "pdf", dpi = 150)

box7
ggsave("../output/figs/rural_aim1_hhmember_contacts.pdf", device = "pdf", dpi = 150)

dev.off()
# box8 <- plot_grid(box1, NULL,
#                   box2, box3,
#                   box4, box5,
#                   box6, box7,
#                   nrow=4, ncol=2,
#                   align="h",rel_heights = c(1,1,1))
# box8
```

# Overall contacts
```{r}
box1
```

# Contacts by age and sex
```{r}
box2
```

# Contacts by education status
```{r}
box3
```

# Contacts by household membership
```{r}
box7
```
\
\

### Figure 1. Distribution of participants by age and sex. 
```{r}
# devtools::install_github('bbc/bbplot')
pacman::p_load('ggalt',
               'forcats', 'R.utils', 'png', 
               'grid', 'ggpubr', 'scales',
               'bbplot','extrafont')

# distribution of age and sex
df_pyramid <- participants%>%
  select(participant_age, participant_sex) %>%
  group_by(participant_age, participant_sex) %>%   # group by id and count number of contacts
  dplyr::summarize(population = n()) %>%
  na.omit()
df_pyramid$population <- df_pyramid$population / sum(df_pyramid$population) * 100
  
rur_pop_pyramid <- ggplot(df_pyramid, aes(x = participant_age, fill = participant_sex,
                                          y = ifelse(test = participant_sex == "Female",
                                                     yes = -population, no = population))) + 
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = abs, limits = max(df_pyramid$population) * c(-1,1)) +
  coord_flip() +
  bbc_style() #+
  # geom_label(aes(x = participant_age, 
  #                y = ifelse(test = participant_sex == "Female",
  #                           yes = -population, no = population),
  #                label = round(population, 0)),
  #            hjust = 0.8, 
  #            vjust = 0.5, 
  #            colour = "black", 
  #            fill = NA, 
  #            label.size = NA, 
  #            family="Gill Sans",
  #            size = 4)

rur_pop_pyramid
# ggsave("../output/figs/rural_aim1_pop_pyramid.pdf", device = "pdf", dpi = 300)
```
\
\

### Figure 2. Distribution of contact characteristics by household membership
```{r}
df_contact_pyramid <- contacts %>%
  select(contact_age, hh_membership) %>%
  group_by(contact_age, hh_membership) %>%   # group by id and count number of contacts
  dplyr::summarize(contacts = n()) %>%
  na.omit()
df_contact_pyramid$contacts <- df_contact_pyramid$contacts / sum(df_contact_pyramid$contacts) * 100
  
rur_contact_pyramid <- ggplot(df_contact_pyramid, aes(x = contact_age, fill = hh_membership,
                                          y = ifelse(test = hh_membership == "Member",
                                                     yes = -contacts, no = contacts))) + 
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = abs, limits = max(df_contact_pyramid$contacts) * c(-1,1)) +
  coord_flip() +
  bbc_style() # +
  # geom_label(aes(x = contact_age, 
  #                y = ifelse(test = contact_age == "Member",
  #                           yes = -contacts, no = contacts),
  #                label = round(contacts, 0)),
  #            hjust = 2,
  #            vjust = 0.5, 
  #            colour = "black", 
  #            fill = NA, 
  #            label.size = NA, 
  #            family="Helvetica", 
  #            size = 4)
rur_contact_pyramid
# ggsave("../output/figs/rural_aim1_contact_hh_pyramid.pdf", device = "pdf", dpi = 300)  

```


### Figure 3: Contact matrices in Manhiça
```{r}
# contact matrices

# recategorise participant age
# table(contacts$participant_age)

source("../scripts/00b_useful_functions.R")

# contacts$participant_age <- contacts$participant_age
# contacts$participant_age <- recode_factor(contacts$participant_age, 
# #                                                 "10-14y"="10-19y", "15-19y"="10-19y")
# contacts$participant_age = factor(contacts$participant_age, 
#                    levels = c("<6mo", "6-11mo", "1-4y", "5-9y", 
#                               "10-14y","15-19", "20-29y", "30-39y", 
#                               "40-59y", "60+y")) #, "I don't know")) # drop I don't know
# contacts$participant_age <- droplevels(contacts$participant_age)
# table(contacts$participant_age)

# table(contacts$contact_age, useNA="always")
# contacts$contact_age = factor(contacts$contact_age, 
#                    levels = c("<6mo", "6-11mo", "1-4y", "5-9y", 
#                               "10-14y","15-19y", "20-29y", "30-39y", 
#                               "40-59y", "60+y"))
# contacts <- filter(contacts, !is.na(contact_age)) 
# drop na in contact_age. check where they come from.
# contacts$contact_age <- droplevels(contacts$contact_age)

standard_str <- data.frame(participant_age = rep(unique(contacts$participant_age), each=10),
                            contact_age = rep(unique(contacts$participant_age),each = 10))
label(standard_str$contact_age) <- "Age group"
label(standard_str$participant_age) <- "Age group"

# table(standard_str$participant_age)
# table(standard_str$contact_age)
# standard_str$contact_age <- as.character(standard_str$contact_age)
# standard_str$participant_age <- as.character(standard_str$participant_age)
standard_str$participant_age = factor(standard_str$participant_age,
                                                levels = c("<6mo", "6-11mo", "1-4y", "5-9y",
                                                           "10-19y", "20-29y", "30-39y",
                                                           "40-59y", "60+y"))


## Number participants by age group
# table(participants$participant_age)
# participants$participant_age <- as.character(participants$participant_age)
# participants$participant_age[participants$participant_age=="10-14y"] <- "10-19y"
# participants$participant_age[participants$participant_age=="15-19y"] <- "10-19y"
# participants$participant_age = factor(participants$participant_age,
#                                                 levels = c("<6mo", "6-11mo", "1-4y", "5-9y",
#                                                            "10-19y", "20-29y", "30-39y",
#                                                            "40-59y", "60+y"))

aim1_n <- participants%>%
  group_by(participant_age) %>%
  dplyr::summarize(n=n()) 
aim1_n$participant_age = factor(aim1_n$participant_age,
                   levels = c("<6mo", "6-11mo", "1-4y", "5-9y",
                              "10-14y","15-19y", "20-29y", "30-39y",
                              "40-59y", "60+y"))
label(aim1_n$participant_age) <- "Age group"

# contacts$contact_age <- as.character(contacts$contact_age)
# contacts$participant_age <- as.character(contacts$participant_age)

# 1. overall matrix
aim1_matrix_all <- make_matrix(contacts,
                          title = "Overall contact matrix",
                          legendpos ="none") +
  theme(plot.title = element_text(size = 20), 
        axis.title.x = element_text(size=18, face="bold"),
        axis.title.y = element_text(size=18, face="bold"),
        axis.text.x = element_text(size = 12, angle=0),
        axis.text.y = element_text(size= 16)) +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)),
            color = "black", size = 4)

aa <- contacts %>%
    group_by(participant_age, contact_age) %>%
    dplyr::summarize(tot_contacts = n())

# 2. by sex
aim1_matrix_male <- contacts %>%
  filter(participant_sex == "Male") %>%
  make_matrix(contacts,
                          title = "Male",
                          legendpos ="none") +
  theme(axis.text.x = element_text(angle = 90)) +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)),
            color = "black", size = 2)

aim1_matrix_female <- contacts %>%
  filter(participant_sex == "Female") %>%
  make_matrix(contacts,
                          title = "Female",
                          legendpos ="none") +  
  theme(axis.text.x = element_text(angle = 90)) +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)),
            color = "black", size = 2)


# # 3. by day of week
# aim1_matrix_weekday <- contacts %>%
#   filter(weekday == "Weekday") %>%
#   make_matrix(contacts,
#                           title = "Weekday",
#                           legendpos ="none") +
#   theme(axis.text.x = element_text(angle = 90)) +
#   geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)),
#             color = "black", size = 2)
# # aim1_matrix_weekday
# 
# aim1_matrix_weekend<- contacts %>%
#   filter(weekday == "Weekend") %>%
#   make_matrix(contacts,
#                           title = "Weekend",
#                           legendpos ="none") +
#   theme(axis.text.x = element_text(angle = 90)) +
#   geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)),
#             color = "black", size = 2)
# # aim1_matrix_weekend


# 4. by household vs nonhousehold member
aim1_matrix_member <- contacts %>%
  filter(hh_membership == "Member") %>%
  make_matrix(contacts,
                          title = "Member",
                          legendpos ="none") +
  theme(axis.text.x = element_text(angle = 90)) +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)),
            color = "black", size = 2)
# aim1_matrix_weekday

aim1_matrix_nonmember <- contacts %>%
  filter(hh_membership == "Non-member") %>%
  make_matrix(contacts,
                          title = "Non-member",
                          legendpos ="none") +
  theme(axis.text.x = element_text(angle = 90)) +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)),
            color = "black", size = 2)
```


#### A. Overall contact matrix
```{r}
aim1_matrix_all
ggsave("../output/figs/rural_aim1_overall_matrix.pdf", device = "pdf", dpi = 300)

```
\
\

#### B. Contact matrix by sex (male vs female)
```{r}
sex_matrix <- plot_grid(aim1_matrix_male, aim1_matrix_female,
                  nrow=1, ncol=2,
                  align="h",rel_heights = c(1,1))
sex_matrix
```
\
\

#### C. Contact matrix by day of week (weekday vs weekend)
```{r}
weekday_matrix <- plot_grid(aim1_matrix_weekday, aim1_matrix_weekend,
                  nrow=1, ncol=2,
                  align="h",rel_heights = c(1,1))
weekday_matrix
```
\
\

#### D. Contact matrix by household membership (member vs non-member)
```{r}
membership_matrix <- plot_grid(aim1_matrix_member, aim1_matrix_nonmember,
                  nrow=1, ncol=2,
                  align="h",rel_heights = c(1,1))
membership_matrix
```
\
\

```{r, include=FALSE}
temp <- participants%>%
  filter(aim==1) %>%
  filter(study_site=="Manhiça")
table(temp$participant_age, temp$read_write)
```